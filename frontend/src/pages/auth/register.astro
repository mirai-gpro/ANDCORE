---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="新規登録">
  <div class="auth-container">
    <div class="auth-card">
      <h1>新規登録</h1>
      <p class="auth-subtitle">アンコールのアカウントを作成</p>

      <div id="auth-message" class="message hidden"></div>

      <form id="register-form" class="auth-form">
        <div class="form-group">
          <label for="nickname">ニックネーム</label>
          <input type="text" id="nickname" name="nickname" required placeholder="表示名を入力" />
        </div>
        <div class="form-group">
          <label for="email">メールアドレス</label>
          <input type="email" id="email" name="email" required placeholder="email@example.com" />
        </div>
        <div class="form-group">
          <label for="password">パスワード</label>
          <input type="password" id="password" name="password" required minlength="8" placeholder="8文字以上のパスワード" />
        </div>
        <div class="form-group">
          <label for="role">ロール</label>
          <select id="role" name="role">
            <option value="fan">ファン</option>
          </select>
          <span class="hint">アイドル・運営アカウントは管理者が発行します</span>
        </div>
        <button type="submit" class="btn btn-primary btn-full">アカウントを作成</button>
      </form>

      <p class="auth-footer">
        すでにアカウントをお持ちの方は <a href="/auth/login">ログイン</a>
      </p>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  const form = document.getElementById('register-form') as HTMLFormElement;
  const messageEl = document.getElementById('auth-message') as HTMLDivElement;

  function showMessage(text: string, isError = false) {
    messageEl.textContent = text;
    messageEl.className = `message ${isError ? 'message-error' : 'message-success'}`;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const nickname = (document.getElementById('nickname') as HTMLInputElement).value;
    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          nickname,
          role: 'fan',
        },
      },
    });

    if (error) {
      showMessage(error.message, true);
      return;
    }

    if (data.user) {
      showMessage('登録が完了しました。メールを確認してください。');
    }
  });
</script>

<style>
  .auth-container {
    display: flex;
    justify-content: center;
    padding: 2rem 0;
  }

  .auth-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 2rem;
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow);
  }

  .auth-card h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .auth-subtitle {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-group label {
    font-size: 0.85rem;
    font-weight: 500;
  }

  .form-group input,
  .form-group select {
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
    background: var(--color-surface);
  }

  .form-group input:focus,
  .form-group select:focus {
    border-color: var(--color-primary);
  }

  .hint {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .btn-full {
    width: 100%;
    padding: 0.75rem;
    border: none;
    border-radius: var(--radius);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
  }

  .auth-footer {
    text-align: center;
    margin-top: 1.5rem;
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .message {
    padding: 0.75rem;
    border-radius: var(--radius);
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }

  .message-error {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }

  .message-success {
    background: #f0fdf4;
    color: #16a34a;
    border: 1px solid #bbf7d0;
  }

  .hidden {
    display: none;
  }
</style>
