---
import Layout from '../../../layouts/Layout.astro';

const { id } = Astro.params;
---

<Layout title="グループ編集">
  <div id="page-loading" class="loading">読み込み中...</div>
  <div id="page-content" class="page hidden">
    <a href="/manage/idols" class="back-link">← アイドル管理に戻る</a>

    <div class="page-header">
      <div>
        <h1 id="page-title">グループ編集</h1>
        <p class="subtitle" id="page-subtitle"></p>
      </div>
      <button id="delete-group-btn" class="btn-danger">グループを削除</button>
    </div>

    <div id="auth-message" class="message hidden"></div>

    <form id="group-form" class="form">
      <!-- グループ情報 -->
      <fieldset class="fieldset">
        <legend>グループ情報</legend>
        <div class="form-group">
          <label for="group-name">グループ名 <span class="required">*</span></label>
          <input type="text" id="group-name" required />
        </div>
        <div class="form-group">
          <label for="catchphrase">キャッチコピー</label>
          <input type="text" id="catchphrase" />
        </div>
        <div class="form-group">
          <label>グループ写真</label>
          <div id="current-photo" class="current-photo"></div>
          <input type="file" id="group-photo" accept="image/*" />
        </div>
      </fieldset>

      <!-- 管理者アカウント -->
      <fieldset class="fieldset">
        <legend>管理者 Googleアカウント</legend>
        <div id="admin-list" class="tag-list"></div>
        <div class="inline-add">
          <input type="email" id="admin-email-input" placeholder="追加のGoogleアカウント" />
          <button type="button" id="add-admin-btn" class="btn-secondary">追加</button>
        </div>
      </fieldset>

      <!-- メンバー -->
      <fieldset class="fieldset">
        <legend>メンバー</legend>
        <div id="members-container"></div>
        <button type="button" id="add-member-btn" class="btn-add-member">+ メンバーを追加</button>
      </fieldset>

      <button type="submit" class="btn-primary btn-submit">変更を保存</button>
    </form>
  </div>

  <!-- 削除確認モーダル -->
  <div id="delete-modal" class="modal hidden">
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div class="modal-content">
      <h3>グループを削除しますか？</h3>
      <p>この操作は取り消せません。全メンバーのデータも削除されます。</p>
      <div class="modal-actions">
        <button id="cancel-delete" class="btn-secondary">キャンセル</button>
        <button id="confirm-delete" class="btn-danger">削除する</button>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ id }}>
  window.__groupId = id;
</script>

<script>
  import { supabase } from '../../../lib/supabase';

  const groupId = (window as any).__groupId;
  const messageEl = document.getElementById('auth-message') as HTMLDivElement;
  let currentUser: any = null;
  let adminEmails: string[] = [];
  let existingMembers: any[] = [];
  let memberIndex = 0;

  function showMessage(text: string, isError = false) {
    messageEl.textContent = text;
    messageEl.className = `message ${isError ? 'message-error' : 'message-success'}`;
  }

  async function uploadPhoto(file: File, path: string): Promise<string | null> {
    const { data, error } = await supabase.storage
      .from('photos')
      .upload(path, file, { upsert: true });
    if (error) return null;
    const { data: urlData } = supabase.storage.from('photos').getPublicUrl(data.path);
    return urlData.publicUrl;
  }

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = '/auth/login'; return; }

    const role = user.user_metadata?.role;
    if (role !== 'organizer' && role !== 'admin') {
      window.location.href = '/dashboard';
      return;
    }
    currentUser = user;

    await supabase.rpc('ensure_profile', {
      target_role: role,
      target_nickname: user.user_metadata?.full_name || user.user_metadata?.name || null,
      target_avatar_url: user.user_metadata?.avatar_url || null,
    });

    // グループ情報取得
    const { data: group, error } = await supabase
      .from('idol_groups')
      .select('*')
      .eq('id', groupId)
      .single();

    if (error || !group) {
      window.location.href = '/manage/idols';
      return;
    }

    (document.getElementById('group-name') as HTMLInputElement).value = group.name;
    (document.getElementById('catchphrase') as HTMLInputElement).value = group.catchphrase || '';
    document.getElementById('page-title')!.textContent = group.name;
    document.getElementById('page-subtitle')!.textContent = group.catchphrase || '';

    if (group.photo_url) {
      document.getElementById('current-photo')!.innerHTML =
        `<img src="${group.photo_url}" alt="${group.name}" />`;
    }

    // 管理者取得
    const { data: admins } = await supabase
      .from('idol_group_admins')
      .select('admin_email')
      .eq('group_id', groupId);

    const adminList = document.getElementById('admin-list')!;
    adminEmails = (admins || []).map(a => a.admin_email);

    adminEmails.forEach(email => {
      const isDefault = email === user.email;
      const tag = document.createElement('span');
      tag.className = `tag ${isDefault ? 'tag-default' : 'tag-added'}`;
      tag.innerHTML = isDefault
        ? `${email} <span class="tag-label">デフォルト</span>`
        : `${email} <button type="button" class="tag-remove" data-email="${email}">&times;</button>`;
      adminList.appendChild(tag);
    });

    // メンバー取得
    const { data: members } = await supabase
      .from('idol_members')
      .select('*')
      .eq('group_id', groupId)
      .order('sort_order');

    existingMembers = members || [];
    existingMembers.forEach(m => addMemberRow(m));

    document.getElementById('page-loading')!.classList.add('hidden');
    document.getElementById('page-content')!.classList.remove('hidden');
  }

  // --- 管理者追加 ---
  document.getElementById('add-admin-btn')!.addEventListener('click', () => {
    const input = document.getElementById('admin-email-input') as HTMLInputElement;
    const email = input.value.trim();
    if (!email || !email.includes('@') || adminEmails.includes(email)) return;

    adminEmails.push(email);
    const tag = document.createElement('span');
    tag.className = 'tag tag-added';
    tag.innerHTML = `${email} <button type="button" class="tag-remove" data-email="${email}">&times;</button>`;
    document.getElementById('admin-list')!.appendChild(tag);
    input.value = '';
  });

  document.getElementById('admin-list')!.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.tag-remove') as HTMLElement;
    if (!btn) return;
    const email = btn.dataset.email!;
    adminEmails = adminEmails.filter(e => e !== email);
    btn.parentElement!.remove();
  });

  // --- メンバー行 ---
  function addMemberRow(existing?: any) {
    const container = document.getElementById('members-container')!;
    const idx = memberIndex++;
    const row = document.createElement('div');
    row.className = 'member-row';
    row.dataset.idx = String(idx);
    row.dataset.memberId = existing?.id || '';

    const photoHtml = existing?.photo_url
      ? `<div class="current-member-photo"><img src="${existing.photo_url}" alt="${existing.name}" /></div>`
      : '';

    row.innerHTML = `
      <div class="member-header">
        <span class="member-number">メンバー ${idx + 1}</span>
        <button type="button" class="btn-remove-member" data-idx="${idx}">&times; 削除</button>
      </div>
      <div class="member-fields">
        <div class="form-group">
          <label>メンバー名 <span class="required">*</span></label>
          <input type="text" class="member-name" data-idx="${idx}" required value="${existing?.name || ''}" />
        </div>
        <div class="form-group">
          <label>Googleアカウント</label>
          <input type="email" class="member-email" data-idx="${idx}" value="${existing?.google_email || ''}" />
        </div>
        <div class="form-group">
          <label>メンバー写真</label>
          ${photoHtml}
          <input type="file" class="member-photo" data-idx="${idx}" accept="image/*" />
        </div>
      </div>
    `;
    container.appendChild(row);
  }

  document.getElementById('add-member-btn')!.addEventListener('click', () => addMemberRow());

  document.getElementById('members-container')!.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.btn-remove-member') as HTMLElement;
    if (!btn) return;
    btn.closest('.member-row')!.remove();
  });

  // --- 保存 ---
  const form = document.getElementById('group-form') as HTMLFormElement;
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const groupName = (document.getElementById('group-name') as HTMLInputElement).value.trim();
    const catchphrase = (document.getElementById('catchphrase') as HTMLInputElement).value.trim();

    if (!groupName) { showMessage('グループ名は必須です。', true); return; }

    const submitBtn = form.querySelector('.btn-submit') as HTMLButtonElement;
    submitBtn.disabled = true;
    showMessage('保存中...');

    try {
      // グループ写真
      let photoUrl: string | undefined;
      const photoFile = (document.getElementById('group-photo') as HTMLInputElement).files?.[0];
      if (photoFile) {
        const path = `idol-groups/${currentUser.id}/${Date.now()}_group.${photoFile.name.split('.').pop()}`;
        const url = await uploadPhoto(photoFile, path);
        if (url) photoUrl = url;
      }

      // グループ更新
      const updateData: any = { name: groupName, catchphrase: catchphrase || null };
      if (photoUrl) updateData.photo_url = photoUrl;

      const { error: updateError } = await supabase
        .from('idol_groups')
        .update(updateData)
        .eq('id', groupId);

      if (updateError) throw updateError;

      // 管理者を全入れ替え
      await supabase.from('idol_group_admins').delete().eq('group_id', groupId);
      if (adminEmails.length > 0) {
        await supabase.from('idol_group_admins')
          .insert(adminEmails.map(email => ({ group_id: groupId, admin_email: email })));
      }

      // メンバーを全入れ替え（既存は削除→再挿入）
      await supabase.from('idol_members').delete().eq('group_id', groupId);

      const memberRows = document.querySelectorAll('.member-row');
      for (let i = 0; i < memberRows.length; i++) {
        const row = memberRows[i] as HTMLElement;
        const nameInput = row.querySelector('.member-name') as HTMLInputElement;
        const emailInput = row.querySelector('.member-email') as HTMLInputElement;
        const photoInput = row.querySelector('.member-photo') as HTMLInputElement;
        const existingId = row.dataset.memberId;

        const name = nameInput.value.trim();
        if (!name) continue;

        // 既存メンバーの写真URLを維持（新しいファイルがなければ）
        let memberPhotoUrl: string | null = null;
        const newFile = photoInput.files?.[0];
        if (newFile) {
          const path = `idol-members/${groupId}/${Date.now()}_${i}.${newFile.name.split('.').pop()}`;
          memberPhotoUrl = await uploadPhoto(newFile, path);
        } else if (existingId) {
          const existing = existingMembers.find(m => m.id === existingId);
          if (existing) memberPhotoUrl = existing.photo_url;
        }

        await supabase.from('idol_members').insert({
          group_id: groupId,
          name,
          google_email: emailInput.value.trim() || null,
          photo_url: memberPhotoUrl,
          sort_order: i,
        });
      }

      showMessage('変更を保存しました。');
      submitBtn.disabled = false;

    } catch (err: any) {
      showMessage('エラー: ' + (err.message || err), true);
      submitBtn.disabled = false;
    }
  });

  // --- 削除 ---
  document.getElementById('delete-group-btn')!.addEventListener('click', () => {
    document.getElementById('delete-modal')!.classList.remove('hidden');
  });

  document.getElementById('cancel-delete')!.addEventListener('click', () => {
    document.getElementById('delete-modal')!.classList.add('hidden');
  });

  document.getElementById('modal-backdrop')?.addEventListener('click', () => {
    document.getElementById('delete-modal')!.classList.add('hidden');
  });

  document.getElementById('confirm-delete')!.addEventListener('click', async () => {
    const { error } = await supabase.from('idol_groups').delete().eq('id', groupId);
    if (error) {
      showMessage('削除に失敗しました: ' + error.message, true);
      document.getElementById('delete-modal')!.classList.add('hidden');
      return;
    }
    window.location.href = '/manage/idols';
  });

  init();
</script>

<style>
  .loading { text-align: center; padding: 3rem; color: var(--color-text-muted); }
  .hidden { display: none; }

  .page { max-width: 680px; margin: 0 auto; }

  .back-link {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    display: inline-block;
    margin-bottom: 0.5rem;
  }
  .back-link:hover { color: var(--color-primary); }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    gap: 1rem;
  }

  .page-header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
  .subtitle { color: var(--color-text-muted); font-size: 0.9rem; }

  .btn-danger {
    padding: 0.5rem 1rem;
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
    align-self: center;
  }
  .btn-danger:hover { background: #dc2626; color: white; }

  .form { display: flex; flex-direction: column; gap: 1.5rem; }

  .fieldset {
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    background: var(--color-surface);
    box-shadow: var(--shadow);
  }

  .fieldset legend {
    font-weight: 700;
    font-size: 0.95rem;
    padding: 0 0.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-bottom: 1rem;
  }
  .form-group:last-child { margin-bottom: 0; }

  .form-group label { font-size: 0.85rem; font-weight: 500; }
  .required { color: #ef4444; }

  .form-group input[type="text"],
  .form-group input[type="email"] {
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .form-group input:focus { border-color: var(--color-primary); }
  .form-group input[type="file"] { font-size: 0.85rem; }

  .current-photo img,
  .current-member-photo img {
    max-width: 160px;
    max-height: 120px;
    border-radius: var(--radius);
    object-fit: cover;
    margin-bottom: 0.5rem;
  }

  /* Tags */
  .tag-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
  .tag {
    display: inline-flex; align-items: center; gap: 0.375rem;
    padding: 0.3rem 0.6rem; border-radius: 9999px; font-size: 0.78rem;
  }
  .tag-default { background: #eef2ff; color: #6366f1; border: 1px solid #c7d2fe; }
  .tag-label {
    font-size: 0.65rem; background: #6366f1; color: white;
    padding: 0.1rem 0.35rem; border-radius: 9999px;
  }
  .tag-added { background: #f3f4f6; color: var(--color-text); border: 1px solid var(--color-border); }
  .tag-remove {
    background: none; border: none; cursor: pointer;
    font-size: 1rem; line-height: 1; color: var(--color-text-muted); padding: 0;
  }
  .tag-remove:hover { color: #ef4444; }

  .inline-add { display: flex; gap: 0.5rem; }
  .inline-add input {
    flex: 1; padding: 0.5rem 0.75rem;
    border: 1px solid var(--color-border); border-radius: var(--radius);
    font-size: 0.85rem; outline: none;
  }
  .inline-add input:focus { border-color: var(--color-primary); }

  .btn-secondary {
    padding: 0.5rem 1rem; border: 1px solid var(--color-primary);
    background: transparent; color: var(--color-primary);
    border-radius: var(--radius); font-size: 0.85rem; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }
  .btn-secondary:hover { background: var(--color-primary); color: white; }

  /* Members */
  .member-row {
    border: 1px solid var(--color-border); border-radius: var(--radius);
    padding: 1rem; margin-bottom: 0.75rem; background: #fafafa;
  }
  .member-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.75rem;
  }
  .member-number { font-size: 0.85rem; font-weight: 600; color: var(--color-primary); }
  .btn-remove-member {
    background: none; border: none; color: #ef4444;
    font-size: 0.8rem; cursor: pointer; padding: 0.25rem 0.5rem;
  }
  .btn-remove-member:hover { text-decoration: underline; }
  .member-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .member-fields .form-group:last-child { grid-column: 1 / -1; }

  .btn-add-member {
    width: 100%; padding: 0.75rem; background: transparent;
    border: 2px dashed var(--color-border); border-radius: var(--radius);
    color: var(--color-text-muted); font-size: 0.9rem; font-weight: 600; cursor: pointer;
  }
  .btn-add-member:hover { border-color: var(--color-primary); color: var(--color-primary); }

  .btn-submit {
    width: 100%; padding: 0.875rem; background: var(--color-primary);
    color: white; border: none; border-radius: var(--radius);
    font-size: 1rem; font-weight: 700; cursor: pointer;
  }
  .btn-submit:hover { background: var(--color-primary-dark); }
  .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-primary { background: var(--color-primary); color: white; }

  /* Modal */
  .modal {
    position: fixed; inset: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: center;
  }
  .modal.hidden {
    display: none;
  }
  .modal-backdrop {
    position: absolute; inset: 0; background: rgba(0,0,0,0.4);
  }
  .modal-content {
    position: relative; background: var(--color-surface);
    border-radius: var(--radius); padding: 2rem;
    max-width: 400px; width: 90%; box-shadow: 0 4px 24px rgba(0,0,0,0.15);
  }
  .modal-content h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
  .modal-content p { font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 1.5rem; }
  .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }

  .message {
    padding: 0.75rem; border-radius: var(--radius);
    font-size: 0.85rem; margin-bottom: 1rem;
  }
  .message-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
  .message-success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

  @media (max-width: 600px) {
    .member-fields { grid-template-columns: 1fr; }
  }
</style>
