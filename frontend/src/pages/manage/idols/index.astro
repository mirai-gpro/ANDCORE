---
import Layout from '../../../layouts/Layout.astro';
---

<Layout title="ã‚¢ã‚¤ãƒ‰ãƒ«ç®¡ç†">
  <div id="page-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="page-content" class="page hidden">

    <div class="page-header">
      <div>
        <a href="/manage" class="back-link">â† é‹å–¶ç®¡ç†ã«æˆ»ã‚‹</a>
        <h1>ã‚¢ã‚¤ãƒ‰ãƒ«ç®¡ç†</h1>
        <p class="subtitle">ã‚°ãƒ«ãƒ¼ãƒ—ã®ç™»éŒ²ãƒ»ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</p>
      </div>
      <a href="/manage/idols/new" class="btn-new">+ æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ç™»éŒ²</a>
    </div>

    <div id="group-list" class="group-list">
      <p class="empty-state">ç™»éŒ²ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    </div>

  </div>
</Layout>

<script>
  import { supabase } from '../../../lib/supabase';

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = '/auth/login'; return; }

    const role = user.user_metadata?.role;
    if (role !== 'organizer' && role !== 'admin') {
      window.location.href = '/dashboard';
      return;
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ + ãƒ¡ãƒ³ãƒãƒ¼æ•°ã‚’å–å¾—
    const { data: groups } = await supabase
      .from('idol_groups')
      .select('id, name, catchphrase, photo_url, created_at, idol_members(id)')
      .eq('organizer_id', user.id)
      .order('created_at', { ascending: false });

    const listEl = document.getElementById('group-list')!;

    if (groups && groups.length > 0) {
      listEl.innerHTML = groups.map(g => {
        const memberCount = Array.isArray(g.idol_members) ? g.idol_members.length : 0;
        const photo = g.photo_url
          ? `<img src="${g.photo_url}" alt="${g.name}" class="group-photo" />`
          : `<div class="group-photo-placeholder">ğŸ¤</div>`;
        return `
          <a href="/manage/idols/${g.id}" class="group-card">
            ${photo}
            <div class="group-info">
              <h3>${g.name}</h3>
              <p class="catchphrase">${g.catchphrase || ''}</p>
              <span class="member-count">${memberCount}äººã®ãƒ¡ãƒ³ãƒãƒ¼</span>
            </div>
            <span class="arrow">â†’</span>
          </a>
        `;
      }).join('');
    }

    document.getElementById('page-loading')!.classList.add('hidden');
    document.getElementById('page-content')!.classList.remove('hidden');
  }

  init();
</script>

<style>
  .loading { text-align: center; padding: 3rem; color: var(--color-text-muted); }
  .hidden { display: none; }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .back-link {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    display: inline-block;
    margin-bottom: 0.5rem;
  }

  .back-link:hover { color: var(--color-primary); }

  .page-header h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 0.9rem;
  }

  .btn-new {
    display: inline-block;
    padding: 0.625rem 1.25rem;
    background: var(--color-primary);
    color: white;
    border-radius: var(--radius);
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.2s;
    white-space: nowrap;
    align-self: center;
  }

  .btn-new:hover {
    background: var(--color-primary-dark);
    color: white;
  }

  /* Group List */
  .group-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .group-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    text-decoration: none;
    color: var(--color-text);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .group-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.12);
    color: var(--color-text);
  }

  .group-photo {
    width: 56px;
    height: 56px;
    border-radius: var(--radius);
    object-fit: cover;
    flex-shrink: 0;
  }

  .group-photo-placeholder {
    width: 56px;
    height: 56px;
    border-radius: var(--radius);
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .group-info {
    flex: 1;
    min-width: 0;
  }

  .group-info h3 {
    font-size: 1rem;
    margin-bottom: 0.125rem;
  }

  .catchphrase {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .member-count {
    font-size: 0.75rem;
    color: var(--color-primary);
    font-weight: 600;
  }

  .arrow {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    flex-shrink: 0;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
  }
</style>
