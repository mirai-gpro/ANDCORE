---
import Layout from '../../../layouts/Layout.astro';
---

<Layout title="イベント管理">
  <div class="page">
    <a href="/manage" class="back-link">&larr; 運営管理に戻る</a>

    <div class="page-header">
      <div>
        <h1>イベント管理</h1>
        <p class="subtitle">イベントの作成・編集・削除</p>
      </div>
      <a href="/manage/events/new" class="btn-primary">+ 新規登録</a>
    </div>

    <div id="loading" class="loading">読み込み中...</div>
    <div id="content" class="hidden">
      <div id="empty-state" class="empty-state hidden">
        <p>まだイベントが登録されていません。</p>
        <a href="/manage/events/new" class="btn-primary">最初のイベントを登録する</a>
      </div>
      <div id="events-list"></div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../../lib/supabase';

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = '/auth/login'; return; }

    const role = user.user_metadata?.role;
    if (role !== 'organizer' && role !== 'admin') {
      window.location.href = '/dashboard';
      return;
    }

    // イベント一覧取得
    const { data: events, error } = await supabase
      .from('events')
      .select('*')
      .eq('organizer_id', user.id)
      .order('created_at', { ascending: false });

    if (error) { console.error(error); return; }

    // 各イベントの日程を取得
    const eventIds = (events || []).map(e => e.id);
    let datesMap: Record<string, any[]> = {};
    if (eventIds.length > 0) {
      const { data: allDates } = await supabase
        .from('event_dates')
        .select('*, event_time_slots(*)')
        .in('event_id', eventIds)
        .order('event_date', { ascending: true });

      for (const d of (allDates || [])) {
        if (!datesMap[d.event_id]) datesMap[d.event_id] = [];
        datesMap[d.event_id].push(d);
      }
    }

    document.getElementById('loading')!.classList.add('hidden');
    document.getElementById('content')!.classList.remove('hidden');

    if (!events || events.length === 0) {
      document.getElementById('empty-state')!.classList.remove('hidden');
      return;
    }

    const list = document.getElementById('events-list')!;
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    for (const event of events) {
      const dates = datesMap[event.id] || [];

      // 最後の開催日を見て過去かどうか判定
      let isPast = false;
      if (dates.length > 0) {
        const lastDate = new Date(dates[dates.length - 1].event_date + 'T23:59:59');
        isPast = lastDate < now;
      }

      const statusLabel = event.status === 'completed' || isPast
        ? '<span class="badge badge-past">開催済</span>'
        : event.status === 'cancelled'
          ? '<span class="badge badge-cancelled">キャンセル</span>'
          : '<span class="badge badge-upcoming">開催前</span>';

      const canEdit = !isPast && event.status !== 'completed' && event.status !== 'cancelled';

      // 日程表示
      let dateHtml = '';
      if (dates.length > 0) {
        dateHtml = dates.map((d: any) => {
          const dateStr = new Date(d.event_date + 'T00:00:00').toLocaleDateString('ja-JP', {
            year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
          });
          const slots = (d.event_time_slots || []).map((s: any) =>
            `${s.door_time.slice(0, 5)}開場 / ${s.start_time.slice(0, 5)}開始`
          ).join('、');
          return `<div class="event-date-line">${dateStr}${slots ? ' ' + slots : ''}</div>`;
        }).join('');
      } else {
        dateHtml = '<div class="event-date-line">日程未定</div>';
      }

      const priceText = event.ticket_price == null ? '無料' : `¥${event.ticket_price.toLocaleString()}`;
      const venueHtml = event.venue_name
        ? `<p class="event-venue">${event.venue_name}${event.venue_map_url ? ` <a href="${event.venue_map_url}" target="_blank" rel="noopener" class="map-link">MAP</a>` : ''}</p>`
        : '';

      const card = document.createElement('div');
      card.className = 'event-card';
      card.innerHTML = `
        <div class="event-card-header">
          <div class="event-title-area">
            <h3>${event.title}</h3>
            ${event.subtitle ? `<p class="event-subtitle">${event.subtitle}</p>` : ''}
          </div>
          ${statusLabel}
        </div>
        ${event.performers ? `<p class="event-performers">${event.performers}</p>` : ''}
        ${venueHtml}
        <div class="event-dates">${dateHtml}</div>
        <p class="event-price">${priceText}</p>
        <div class="event-actions">
          ${canEdit
            ? `<a href="/manage/events/${event.id}" class="btn-action btn-edit">編集</a>
               <button class="btn-action btn-delete" data-id="${event.id}" data-title="${event.title}">削除</button>`
            : `<a href="/manage/events/new?copy=${event.id}" class="btn-action btn-copy">コピーして新規登録</a>`
          }
        </div>
      `;
      list.appendChild(card);
    }

    // 削除ボタンのイベント
    list.addEventListener('click', async (e) => {
      const btn = (e.target as HTMLElement).closest('.btn-delete') as HTMLElement;
      if (!btn) return;

      const id = btn.dataset.id!;
      const title = btn.dataset.title!;
      if (!confirm(`「${title}」を削除してもよろしいですか？\nこの操作は取り消せません。`)) return;

      const { error } = await supabase.from('events').delete().eq('id', id);
      if (error) {
        alert('削除に失敗しました: ' + error.message);
        return;
      }

      btn.closest('.event-card')!.remove();

      // 全部消えたら空表示
      if (list.children.length === 0) {
        document.getElementById('empty-state')!.classList.remove('hidden');
      }
    });
  }

  init();
</script>

<style>
  .page { max-width: 800px; margin: 0 auto; }

  .back-link {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    display: inline-block;
    margin-bottom: 0.5rem;
  }
  .back-link:hover { color: var(--color-primary); }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 0.9rem;
  }

  .btn-primary {
    display: inline-block;
    padding: 0.6rem 1.25rem;
    background: var(--color-primary);
    color: white !important;
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
    white-space: nowrap;
    transition: background 0.2s;
  }
  .btn-primary:hover { background: var(--color-primary-dark); color: white; }

  .loading {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }

  .hidden { display: none; }

  .empty-state {
    text-align: center;
    padding: 3rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
  }

  .empty-state p {
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  /* イベントカード */
  .event-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow);
  }

  .event-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .event-title-area h3 {
    font-size: 1.05rem;
    line-height: 1.3;
  }

  .event-subtitle {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    margin-top: 0.125rem;
  }

  .badge {
    flex-shrink: 0;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .badge-upcoming { background: #dbeafe; color: #2563eb; }
  .badge-past { background: #f3f4f6; color: #6b7280; }
  .badge-cancelled { background: #fef2f2; color: #dc2626; }

  .event-performers {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    margin-bottom: 0.25rem;
  }

  .event-venue {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .map-link {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.1rem 0.4rem;
    background: #eef2ff;
    border-radius: 4px;
    color: var(--color-primary) !important;
  }

  .event-dates {
    margin-bottom: 0.5rem;
  }

  .event-date-line {
    font-size: 0.82rem;
    color: var(--color-text);
    padding: 0.125rem 0;
  }

  .event-price {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .event-actions {
    display: flex;
    gap: 0.5rem;
    border-top: 1px solid var(--color-border);
    padding-top: 0.75rem;
  }

  .btn-action {
    padding: 0.4rem 1rem;
    border-radius: var(--radius);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    border: 1px solid;
    background: transparent;
  }

  .btn-edit {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }
  .btn-edit:hover { background: var(--color-primary); color: white; }

  .btn-delete {
    border-color: #ef4444;
    color: #ef4444;
  }
  .btn-delete:hover { background: #ef4444; color: white; }

  .btn-copy {
    border-color: #059669;
    color: #059669;
  }
  .btn-copy:hover { background: #059669; color: white; }
</style>
