---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="é‹å–¶ç®¡ç†">
  <div id="manage-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="manage-content" class="manage hidden">
    <div class="page-header">
      <h1>é‹å–¶ç®¡ç†</h1>
      <p class="subtitle">ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚¢ã‚¤ãƒ‰ãƒ«ãƒ»ãƒã‚±ãƒƒãƒˆã®ç®¡ç†</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <p class="stat-label">ã‚¤ãƒ™ãƒ³ãƒˆæ•°</p>
        <p class="stat-value" id="event-count">0</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">æ‰€å±ã‚¢ã‚¤ãƒ‰ãƒ«</p>
        <p class="stat-value" id="idol-count">0</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">ä»Šæœˆã®è²©å£²ãƒã‚±ãƒƒãƒˆ</p>
        <p class="stat-value" id="ticket-count">0</p>
      </div>
    </div>

    <div class="section">
      <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <div class="menu-grid">
        <a href="/manage/events" class="menu-card">
          <div class="menu-icon">ğŸ“…</div>
          <h3>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h3>
          <p>ç‰¹å…¸ä¼šã®ä½œæˆãƒ»ç·¨é›†ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</p>
        </a>
        <a href="/manage/idols" class="menu-card">
          <div class="menu-icon">ğŸ¤</div>
          <h3>ã‚¢ã‚¤ãƒ‰ãƒ«ç®¡ç†</h3>
          <p>æ‰€å±ã‚¢ã‚¤ãƒ‰ãƒ«ã®ç™»éŒ²ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†</p>
        </a>
        <a href="/manage/tickets" class="menu-card">
          <div class="menu-icon">ğŸ«</div>
          <h3>ãƒã‚±ãƒƒãƒˆç®¡ç†</h3>
          <p>ç‰¹å…¸åˆ¸å•†å“ã®è¨­å®šãƒ»è²©å£²çŠ¶æ³ã®ç¢ºèª</p>
        </a>
        <a href="/manage/media" class="menu-card">
          <div class="menu-icon">ğŸ“¸</div>
          <h3>æ’®å½±ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
          <p>æ’®å½±å†™çœŸã®æ‰¿èªãƒ»å…¬é–‹ç®¡ç†</p>
        </a>
      </div>
    </div>

    <button id="logout-btn" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = '/auth/login';
      return;
    }

    const role = user.user_metadata?.role;
    if (role !== 'organizer' && role !== 'admin') {
      window.location.href = '/dashboard';
      return;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’å–å¾—
    const { count: eventCount } = await supabase
      .from('events')
      .select('*', { count: 'exact', head: true })
      .eq('organizer_id', user.id);

    document.getElementById('event-count')!.textContent = String(eventCount ?? 0);

    document.getElementById('manage-loading')!.classList.add('hidden');
    document.getElementById('manage-content')!.classList.remove('hidden');
  }

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  });

  init();
</script>

<style>
  .loading {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }

  .hidden {
    display: none;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 0.9rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
    box-shadow: var(--shadow);
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .section h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
  }

  .menu-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    transition: border-color 0.2s, box-shadow 0.2s;
    color: var(--color-text);
    text-decoration: none;
  }

  .menu-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    color: var(--color-text);
  }

  .menu-icon {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .menu-card h3 {
    font-size: 1rem;
    margin-bottom: 0.375rem;
  }

  .menu-card p {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.4;
  }

  .btn-logout {
    margin-top: 2rem;
    padding: 0.5rem 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    background: var(--color-surface);
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--color-text);
  }
  .btn-logout:hover { border-color: #dc2626; color: #dc2626; }
</style>
