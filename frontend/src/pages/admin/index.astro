---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="ANDCOREç®¡ç†">
  <div id="admin-loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="admin-content" class="admin hidden">
    <div class="page-header">
      <div class="header-row">
        <div>
          <h1>ANDCORE ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†</h1>
          <p class="subtitle">ã‚µãƒ¼ãƒ“ã‚¹å…¨ä½“ã®ç®¡ç†ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</p>
        </div>
        <span class="badge-admin">ADMIN</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <p class="stat-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</p>
        <p class="stat-value" id="total-users">0</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">é‹å–¶è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</p>
        <p class="stat-value" id="organizer-count">0</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</p>
        <p class="stat-value" id="total-events">0</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ</p>
        <p class="stat-value" id="active-events">0</p>
      </div>
    </div>

    <div class="section">
      <h2>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†</h2>
      <div class="menu-grid">
        <a href="/admin/organizers" class="menu-card">
          <div class="menu-icon">ğŸ¢</div>
          <h3>é‹å–¶è€…ç®¡ç†</h3>
          <p>é‹å–¶è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç™ºè¡Œãƒ»åœæ­¢ãƒ»æ¨©é™ç®¡ç†</p>
        </a>
        <a href="/admin/users" class="menu-card">
          <div class="menu-icon">ğŸ‘¥</div>
          <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
          <p>å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ãƒ»ãƒ­ãƒ¼ãƒ«å¤‰æ›´ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ“ä½œ</p>
        </a>
        <a href="/admin/events" class="menu-card">
          <div class="menu-icon">ğŸ“…</div>
          <h3>ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–</h3>
          <p>å…¨ã‚¤ãƒ™ãƒ³ãƒˆã®çŠ¶æ³ç¢ºèªãƒ»å¼·åˆ¶åœæ­¢</p>
        </a>
        <a href="/admin/reports" class="menu-card">
          <div class="menu-icon">ğŸ“Š</div>
          <h3>å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ</h3>
          <p>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®å£²ä¸Šãƒ»KPI</p>
        </a>
        <a href="/admin/settings" class="menu-card">
          <div class="menu-icon">âš™ï¸</div>
          <h3>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
          <p>ãƒã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒˆãƒ»æ‰‹æ•°æ–™ãƒ»åˆ©ç”¨è¦ç´„</p>
        </a>
        <a href="/admin/audit" class="menu-card">
          <div class="menu-icon">ğŸ“‹</div>
          <h3>ç›£æŸ»ãƒ­ã‚°</h3>
          <p>ç®¡ç†æ“ä½œã®å±¥æ­´ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°</p>
        </a>
      </div>
    </div>

    <button id="logout-btn" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = '/auth/login';
      return;
    }

    const role = user.user_metadata?.role;
    if (role !== 'admin') {
      window.location.href = '/dashboard';
      return;
    }

    // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
    const [usersRes, organizersRes, eventsRes, activeEventsRes] = await Promise.all([
      supabase.from('profiles').select('*', { count: 'exact', head: true }),
      supabase.from('profiles').select('*', { count: 'exact', head: true }).eq('role', 'organizer'),
      supabase.from('events').select('*', { count: 'exact', head: true }),
      supabase.from('events').select('*', { count: 'exact', head: true }).eq('status', 'active'),
    ]);

    document.getElementById('total-users')!.textContent = String(usersRes.count ?? 0);
    document.getElementById('organizer-count')!.textContent = String(organizersRes.count ?? 0);
    document.getElementById('total-events')!.textContent = String(eventsRes.count ?? 0);
    document.getElementById('active-events')!.textContent = String(activeEventsRes.count ?? 0);

    document.getElementById('admin-loading')!.classList.add('hidden');
    document.getElementById('admin-content')!.classList.remove('hidden');
  }

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  });

  init();
</script>

<style>
  .loading {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }

  .hidden {
    display: none;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .page-header h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 0.9rem;
  }

  .badge-admin {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #dc2626;
    color: white;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
    box-shadow: var(--shadow);
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .section h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
  }

  .menu-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    transition: border-color 0.2s, box-shadow 0.2s;
    color: var(--color-text);
    text-decoration: none;
  }

  .menu-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    color: var(--color-text);
  }

  .menu-icon {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .menu-card h3 {
    font-size: 1rem;
    margin-bottom: 0.375rem;
  }

  .menu-card p {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.4;
  }

  .btn-logout {
    margin-top: 2rem;
    padding: 0.5rem 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    background: var(--color-surface);
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--color-text);
  }
  .btn-logout:hover { border-color: #dc2626; color: #dc2626; }
</style>
